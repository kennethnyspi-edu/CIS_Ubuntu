---
# playbook CIS
# Kenneth Masis -- > Changed 04/23/2025
# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------
- name: "CIS | hardening run"
##  remote_user: "{{ ansible_user }}"
  hosts: all
  become: true
  vars:
    pl_a_var_client_server: "{{ true if inventory_hostname in (groups['clients'] | default([])) else false }}"
    pl_a_var_server_client: "{{ false if inventory_hostname in (groups['clients'] | default([])) else true }}"
    # pl_a_cis_preferred_capturing_log_method: "{{ 'rsyslog' if inventory_hostname in (groups['clients'] | default([])) else 'journald' }}"
  tasks:

  - name: "Include Ubuntu 20.04 CIS role"
    when:
    - pl_a_cis_setup is defined
    - pl_a_cis_setup | bool
    - ansible_distribution | lower == "ubuntu"
    - ansible_distribution_version in ["20.04"]
    ansible.builtin.include_role:
      name: ansible-cis-ubuntu-2004
    vars:
      cis_ubuntu2004_section1: true
      cis_ubuntu2004_section2: true
      cis_ubuntu2004_section3: true
      cis_ubuntu2004_section4: true
      cis_ubuntu2004_section5: true
      cis_ubuntu2004_section6: true

      # ---Section 1 --------------------
      cis_ubuntu2004_rule_1_1_1_1: true # cramfs
      cis_ubuntu2004_rule_1_1_1_2: true # freevxfs
      cis_ubuntu2004_rule_1_1_1_3: true # jffs2
      cis_ubuntu2004_rule_1_1_1_4: true # hfs
      cis_ubuntu2004_rule_1_1_1_5: true # hfsplus

      cis_ubuntu2004_rule_1_1_2_1: true # /tmp on separate partition
      cis_ubuntu2004_rule_1_1_2_2: true # nodev for /tmp
      cis_ubuntu2004_rule_1_1_2_3: true # nosexec for /tmp
      cis_ubuntu2004_rule_1_1_2_4: true # nosuid for /tmp

      cis_ubuntu2004_rule_1_1_3_2: true # nodev for /var
      cis_ubuntu2004_rule_1_1_3_3: true # nosuid for /var

      cis_ubuntu2004_rule_1_1_4_2: true # nodev for /var/tmp
      cis_ubuntu2004_rule_1_1_4_3: true # noexec for /var/tmp
      cis_ubuntu2004_rule_1_1_4_4: true # nosuid for /var/tmp

      cis_ubuntu2004_rule_1_1_5_2: true # nodev for /var/log
      cis_ubuntu2004_rule_1_1_5_3: true # noexec for /var/log
      cis_ubuntu2004_rule_1_1_5_4: true # nosuid for /var/log

      cis_ubuntu2004_rule_1_1_6_2: true # nodev for /var/log/audit
      cis_ubuntu2004_rule_1_1_6_3: true # noexec for /var/log/audit
      cis_ubuntu2004_rule_1_1_6_4: true # nosuid for /var/log/audit

      cis_ubuntu2004_rule_1_1_7_2: true # nodev for /home
      cis_ubuntu2004_rule_1_1_7_3: true # nosuid for /home

      cis_ubuntu2004_rule_1_1_8_1: true # nodev for /dev/shm
      cis_ubuntu2004_rule_1_1_8_2: true # noexec for /dev/shm
      cis_ubuntu2004_rule_1_1_8_3: true # nosuid for /dev/shm

      cis_ubuntu2004_rule_1_1_9: true # Disable automounting
      cis_ubuntu2004_rule_1_1_10: true # Disable USB Storage

      cis_ubuntu2004_rule_1_2_1: true # Ensure AIDE is installed
      cis_ubuntu2004_rule_1_2_2: true # Ensure filesystem integrity is regularly checked

      cis_ubuntu2004_rule_1_3_1: false # Ensure updates for installed packages -- MANUAL
      cis_ubuntu2004_rule_1_3_2: false # Ensure package manager repositories are configured -- MANUAL
      cis_ubuntu2004_rule_1_3_3: false # Ensure GPG keys are configured -- MANUAL

      cis_ubuntu2004_rule_1_4_1: False # Ensure bootloader password is set
      cis_ubuntu2004_rule_1_4_2: true # Ensure bootloader permissions are configured
      cis_ubuntu2004_rule_1_4_3: true # Ensure authentication required for single user mode

      cis_ubuntu2004_rule_1_5_1: true # Ensure prelink is disabled
      cis_ubuntu2004_rule_1_5_2: true # Ensure address space layout randomization (ASLR) is enabled
      cis_ubuntu2004_rule_1_5_3: true # Ensure ptrace scope is set to restricted
      cis_ubuntu2004_rule_1_5_4: true # Ensure automatic error reporting is disabled
      cis_ubuntu2004_rule_1_5_5: true # Ensure core dumps are restricted

      cis_ubuntu2004_rule_1_6_1_1: true # Ensure AppArmor is installed
      cis_ubuntu2004_rule_1_6_1_2: true # Ensure AppArmor is enabled in the bootloader configuration
      cis_ubuntu2004_rule_1_6_1_3: true # Ensure all AppArmor profiles are in enforce or complain mode

      cis_ubuntu2004_rule_1_7_1: true # Ensure message of the day is configured properly
      cis_ubuntu2004_rule_1_7_2: true # Ensure local login warning banner is configured properly
      cis_ubuntu2004_rule_1_7_3: true # Ensure remote login warning banner is configured properly
      cis_ubuntu2004_rule_1_7_4: true # Ensure permissions on /etc/motd are configured
      cis_ubuntu2004_rule_1_7_5: true # Ensure permissions on /etc/issue are configured
      cis_ubuntu2004_rule_1_7_6: true # Ensure permissions on /etc/issue.net are configured

      cis_ubuntu2004_rule_1_8_2: true # Ensure GDM login banner is configured properly
      cis_ubuntu2004_rule_1_8_3: true # Ensure GDM disable-user-list is enabled
      cis_ubuntu2004_rule_1_8_4: true # Ensure GDM screen locks when idle
      cis_ubuntu2004_rule_1_8_5: true # Ensure GDM screen locks cannot be overridden
      cis_ubuntu2004_rule_1_8_6: true # Ensure GDM automatic mounting is disabled
      cis_ubuntu2004_rule_1_8_7: true # Ensure GDM disabling automatic mounting cannot be overridden
      cis_ubuntu2004_rule_1_8_8: true # Ensure GDM autorun us enabled
      cis_ubuntu2004_rule_1_8_9: true # Ensure GDM autorun cannot be overridden
      cis_ubuntu2004_rule_1_8_10: true # Ensure XDCMP is not enabled

      # ---Section 2 --------------------
      cis_ubuntu2004_rule_2_1_1_1: true # Ensure a single time synchronization service is enabled
      cis_ubuntu2004_rule_2_1_2_1: false # Ensure Chrony is configured -- MANUAL
      cis_ubuntu2004_rule_2_1_2_2: true # Ensure Chrony is running
      cis_ubuntu2004_rule_2_1_2_3: true # Ensure Chrony is enabled
      cis_ubuntu2004_rule_2_1_3_1: true # Ensure systemd-timesyncd is configured
      cis_ubuntu2004_rule_2_1_3_2: false # Ensure systemd-timesyncd is running  -- MANUAL
      cis_ubuntu2004_rule_2_1_4_1: true # Ensure NTP access control is configured
      cis_ubuntu2004_rule_2_1_4_2: false # Ensure NTP is configured -- MANUAL
      cis_ubuntu2004_rule_2_1_4_3: true # Ensure NTP is running
      cis_ubuntu2004_rule_2_1_4_4: true # Ensure NTP is enabled

      cis_ubuntu2004_rule_2_2_2: true # Ensure Avahi server is not installed
      cis_ubuntu2004_rule_2_2_3: true # Ensure CUPS is not installed
      cis_ubuntu2004_rule_2_2_4: true # Ensure DHCP server is not installed
      cis_ubuntu2004_rule_2_2_5: true # Ensure LDAP server is not installed
      cis_ubuntu2004_rule_2_2_6: true # Ensure NFS is not installed
      cis_ubuntu2004_rule_2_2_7: true # Ensure DNS server is not installed
      cis_ubuntu2004_rule_2_2_8: true # Ensure FTP server is not installed
      cis_ubuntu2004_rule_2_2_9: false # Ensure HTTP server is not installed
      cis_ubuntu2004_rule_2_2_10: true # Ensure IMAP and POP3 server is not installed
      cis_ubuntu2004_rule_2_2_11: true # Ensure Samba is not installed
      cis_ubuntu2004_rule_2_2_12: true # Ensure HTTP proxy server is not installed
      cis_ubuntu2004_rule_2_2_13: true # Ensure SNMP server is not installed
      cis_ubuntu2004_rule_2_2_14: true # Ensure NIS server is not installed
      cis_ubuntu2004_rule_2_2_15: true # Ensure dnsmasq is not installed
      cis_ubuntu2004_rule_2_2_16: true # Ensure mail transfer agent is configured for local-only mode
      cis_ubuntu2004_rule_2_2_17: true # Ensure rsync service is not installed

      cis_ubuntu2004_rule_2_3_1: true # Ensure NIS client is not installed
      cis_ubuntu2004_rule_2_3_2: true # Ensure rsh client is not installed
      cis_ubuntu2004_rule_2_3_3: true # Ensure talk client is not installed
      cis_ubuntu2004_rule_2_3_4: true # Ensure telnet client is not installed
      cis_ubuntu2004_rule_2_3_5: true # Ensure LDAP client is not installed
      cis_ubuntu2004_rule_2_3_6: true # Ensure RPC is not installed

      cis_ubuntu2004_rule_2_4: false # Ensure nonessential services are removed or masked -- MANUAL

      # ---Section 3 --------------------
      cis_ubuntu2004_rule_3_1_1: false # NOTE: depends also on 'cis_ubuntu2004_required_ipv6' -- MANUAL
      cis_ubuntu2004_rule_3_1_2: true  # NOTE: depends also on 'cis_ubuntu2004_required_ipv6'
      cis_ubuntu2004_rule_3_1_3: true  # NOTE: depends also on 'cis_ubuntu2004_required_ipv6'
      cis_ubuntu2004_rule_3_2_1: true  # Ensure packet redirect sending is disabled
      cis_ubuntu2004_rule_3_2_2: true  # Ensure IP forwarding is disabled
      cis_ubuntu2004_rule_3_3_1: true  # Ensure source routed packets are not accepted
      cis_ubuntu2004_rule_3_3_2: true  # Ensure ICMP redirects are not accepted
      cis_ubuntu2004_rule_3_3_3: true  # Ensure secure ICMP redirects are not accepted
      cis_ubuntu2004_rule_3_3_4: true  # Ensure suspicious packets are logged
      cis_ubuntu2004_rule_3_3_5: true  # Ensure broadcast ICMP requests are ignored
      cis_ubuntu2004_rule_3_3_6: true  # Ensure bogus ICMP responses are ignored
      cis_ubuntu2004_rule_3_3_7: true  # Ensure Reverse Path Filtering is enabled
      cis_ubuntu2004_rule_3_3_8: true  # Ensure TCP SYN Cookies is enabled
      cis_ubuntu2004_rule_3_3_9: true  # Ensure IPv6 router advertisements are not accepted

      cis_ubuntu2004_rule_3_4_1_1: true # Ensure ufw is installed
      cis_ubuntu2004_rule_3_4_1_2: true # Ensure iptables-persistent is not installed with ufw
      cis_ubuntu2004_rule_3_4_1_3: true # Ensure ufw service is enabled
      cis_ubuntu2004_rule_3_4_1_4: true # Ensure ufw loopback traffic is configured
      cis_ubuntu2004_rule_3_4_1_5: false # Ensure ufw outbound connections are configured -- MANUAL
      cis_ubuntu2004_rule_3_4_1_6: true # Ensure ufw firewall rules exist
      cis_ubuntu2004_rule_3_4_1_7: true # Ensure ufw default deny firewall policy

      cis_ubuntu2004_rule_3_4_2_1: true # Ensure nftables is installed
      cis_ubuntu2004_rule_3_4_2_2: true # Ensure ufw is not installed with nftables
      cis_ubuntu2004_rule_3_4_2_3: false # Ensure iptables are flushed with nftables -- MANUAL
      cis_ubuntu2004_rule_3_4_2_4: true # Ensure a nftables table exists
      cis_ubuntu2004_rule_3_4_2_5: true # Emnsure nftables chains exist
      cis_ubuntu2004_rule_3_4_2_6: true # Ensure nftables loopback traffic is configured
      cis_ubuntu2004_rule_3_4_2_7: false # Ensure nftables outbound connections are configured -- MANUAL
      cis_ubuntu2004_rule_3_4_2_8: true # Ensure nftables default deny firewall policy
      cis_ubuntu2004_rule_3_4_2_9: true # Ensure nftables service is enabled
      cis_ubuntu2004_rule_3_4_2_10: true # Ensure nftables rules are permanent

      cis_ubuntu2004_rule_3_4_3_1_1: true # Ensure iptables is installed
      cis_ubuntu2004_rule_3_4_3_1_2: true # Ensure nftables is not installed with iptables
      cis_ubuntu2004_rule_3_4_3_1_3: true # Ensure ufw is not installed with iptables

      cis_ubuntu2004_rule_3_4_3_2_1: true # Ensure iptables default deny firewall policy
      cis_ubuntu2004_rule_3_4_3_2_2: true # Ensure iptables loopback traffic is configured
      cis_ubuntu2004_rule_3_4_3_2_3: False # Ensure iptables outbound connections are configured -- MANUAL
      cis_ubuntu2004_rule_3_4_3_2_4: true # Ensure iptables firewall rules exist

      # IPV6 ip6tables rules
      cis_ubuntu2004_rule_3_4_3_3_1: false # Ensure ip6tables default deny firewall policy
      cis_ubuntu2004_rule_3_4_3_3_2: False # Ensure ip6tables loopback traffic is configured
      cis_ubuntu2004_rule_3_4_3_3_3: false # Ensure ip6tables outbound connections are configured
      cis_ubuntu2004_rule_3_4_3_3_4: false # Ensure ip6tables firewall rules exist

      # ---Section 4 --------------------
      cis_ubuntu2004_rule_4_1_1: true  # Ensure cron daemon is enabled
      cis_ubuntu2004_rule_4_1_2: true  # Ensure permissions on /etc/crontab are configured
      cis_ubuntu2004_rule_4_1_3: true  # Ensure permissions on /etc/cron.hourly are configured
      cis_ubuntu2004_rule_4_1_4: true  # Ensure permissions on /etc/cron.daily are configured
      cis_ubuntu2004_rule_4_1_5: true  # Ensure permissions on /etc/cron.weekly are configured
      cis_ubuntu2004_rule_4_1_6: true  # Ensure permissions on /etc/cron.monthly are configured
      cis_ubuntu2004_rule_4_1_7: true  # Ensure permissions on /etc/cron.d are configured
      cis_ubuntu2004_rule_4_1_8: true  # Ensure cron is restricted to authorized users
      cis_ubuntu2004_rule_4_1_9: true  # Ensure at is restricted to authorized users

      cis_ubuntu2004_rule_4_2_1: true # Ensure permissions on /etc/ssh/sshd_config are configured
      cis_ubuntu2004_rule_4_2_2: true # Ensure permissions on SSH private host key files are configured
      cis_ubuntu2004_rule_4_2_3: true # Ensure permissions on SSH public host key files are configured
      cis_ubuntu2004_rule_4_2_4: true # Ensure SSH access is limited
      cis_ubuntu2004_rule_4_2_5: true # Ensure SSH LogLevel is appropriate
      cis_ubuntu2004_rule_4_2_6: true # Ensure SSH PAM is enabled
      cis_ubuntu2004_rule_4_2_7: true # Ensure SSH root login is disabled
      cis_ubuntu2004_rule_4_2_8: true # Ensure SSH HostbasedAuthentication is disabled
      cis_ubuntu2004_rule_4_2_9: true # Ensure SSH PermitEmptyPasswords is disabled
      cis_ubuntu2004_rule_4_2_10: true # Ensure SSH PermitUserEnvironment is disabled
      cis_ubuntu2004_rule_4_2_11: true # Ensure SSH IgnoreRhosts is enabled
      cis_ubuntu2004_rule_4_2_13: true # Ensure only strong Ciphers are used
      cis_ubuntu2004_rule_4_2_14: true # Ensure only strong MAC algorithms are used
      cis_ubuntu2004_rule_4_2_15: true # Ensure only strong Key Exchange algorithms are used
      cis_ubuntu2004_rule_4_2_17: true # Ensure SSH warning banner is configured
      cis_ubuntu2004_rule_4_2_18: true # Ensure SSH MaxAuthTries is set to 4 or less
      cis_ubuntu2004_rule_4_2_19: true # Ensure SSH MaxStartups is configured
      cis_ubuntu2004_rule_4_2_20: true # Ensure SSH LoginGraceTime is set to one minute or less
      cis_ubuntu2004_rule_4_2_21: true # Ensure SSH MaxSessions is set to 10 or less
      cis_ubuntu2004_rule_4_2_22: true # Ensure SSH Idle timeout interval is configured

      cis_ubuntu2004_rule_4_3_1: true # Ensure sudo is installed
      cis_ubuntu2004_rule_4_3_2: true # Ensure sudo commands use pty
      cis_ubuntu2004_rule_4_3_3: true # Ensure sudo log file exists
      cis_ubuntu2004_rule_4_3_5: true # Ensure re-authentication for privilege escalation is not disabled globally
      cis_ubuntu2004_rule_4_3_6: true # Ensure sudo authentication timeout is configured correctly
      cis_ubuntu2004_rule_4_3_7: true # Ensure sudo access to the su command is restricted

      cis_ubuntu2004_rule_4_4_1: true # Ensure password creation requirements are configured
      cis_ubuntu2004_rule_4_4_2: true # Ensure lockout for failed password attempts is configured
      cis_ubuntu2004_rule_4_4_3: true # Ensure password reuse is limited
      cis_ubuntu2004_rule_4_4_4: true # Ensure strong password hashing algorithm is configured
      cis_ubuntu2004_rule_4_4_5: false # Ensure all current passwords uses the configured hashing algorithm -- MANUAL

      cis_ubuntu2004_rule_4_5_1_1: true # Ensure minimum days between password changes is configured
      cis_ubuntu2004_rule_4_5_1_2: true # Ensure password expiration is 365 days or less
      cis_ubuntu2004_rule_4_5_1_3: true # Ensure password expiration warning days is 7 or more
      cis_ubuntu2004_rule_4_5_1_4: true # Ensure inactive password lock is 30 days or less
      cis_ubuntu2004_rule_4_5_1_5: true # Ensure all users last password change date is in the past
      cis_ubuntu2004_rule_4_5_1_6: true # Ensure the number of changed characters in new passwords is configured
      cis_ubuntu2004_rule_4_5_1_7: true # Ensure preventing the use of dictionary words in passwords is configured

      cis_ubuntu2004_rule_4_5_2: true # Ensure system accounts are secured
      cis_ubuntu2004_rule_4_5_3: true # Ensure default group for the root account is GID 0
      cis_ubuntu2004_rule_4_5_4: true # Ensure default user umask is 027 or more restrictive
      cis_ubuntu2004_rule_4_5_5: true # Ensure default user shell timeout is configured
      cis_ubuntu2004_rule_4_5_7: true # Ensure maximun number of same consecutive characters in new passwords is configured

      # ---Section 5 --------------------
      cis_ubuntu2204_rule_5_1_1_1_1: true # Ensure systemd-jounal-remote is installed
      cis_ubuntu2204_rule_5_1_1_1_2: false # Ensure systemd-jounal-remote is configured -- MANUAL
      cis_ubuntu2204_rule_5_1_1_1_3: false # Ensure systemd-jounal-remote is enabled -- MANUAL
      cis_ubuntu2204_rule_5_1_1_1_4: true # Ensure journald is not configured to receive logs from a remote client

      cis_ubuntu2204_rule_5_1_1_2: true # Ensure journald service is enabled
      cis_ubuntu2204_rule_5_1_1_3: true # Ensure journald is configured to compress large log files
      cis_ubuntu2204_rule_5_1_1_4: true # Ensure journald is configured to write logfiles to persistent disk
      cis_ubuntu2204_rule_5_1_1_5: false # Ensure journald is not configured to send logs to rsyslog -- MANUAL
      cis_ubuntu2204_rule_5_1_1_6: false # Ensure journald log rotation is configured per site policy -- MANUAL
      cis_ubuntu2204_rule_5_1_1_7: false # Ensure journald default file permissions are configured -- MANUAL

      cis_ubuntu2204_rule_5_1_2_1: true # Ensure rsyslog is installed
      cis_ubuntu2204_rule_5_1_2_2: true # Ensure rsyslog is enabled
      cis_ubuntu2204_rule_5_1_2_3: false # Ensure journald is configured to send logs to rsyslog -- MANUAL
      cis_ubuntu2204_rule_5_1_2_4: true # Ensure rsyslog default file permissions are configured
      cis_ubuntu2204_rule_5_1_2_5: false # Ensure logging is configured -- MANUAL
      cis_ubuntu2204_rule_5_1_2_6: false # Ensure rsyslog is configured to send logs to a remote log host -- MANUAL
      cis_ubuntu2204_rule_5_1_2_7: false # Ensure rsyslog is not configured to receive logs from a remote client

      cis_ubuntu2204_rule_5_1_3: true # Ensure all logfiles have appropriate access confifured

      cis_ubuntu2004_rule_5_2_4_11: true # Ensure cryptographic mechanisms are used to protect the integrity of audit tools

      # ---Section 6 --------------------
      cis_ubuntu2004_rule_6_1_1: true # Ensure permissions on /etc/passwd are configured
      cis_ubuntu2004_rule_6_1_2: true # Ensure permissions on /etc/passwd- are configured
      cis_ubuntu2004_rule_6_1_3: true # Ensure permissions on /etc/group are configured
      cis_ubuntu2004_rule_6_1_4: true # Ensure permissions on /etc/group- are configured
      cis_ubuntu2004_rule_6_1_5: true # Ensure permissions on /etc/shadow are configured
      cis_ubuntu2004_rule_6_1_6: true # Ensure permissions on /etc/shadow- are configured
      cis_ubuntu2004_rule_6_1_7: true # Ensure permissions on /etc/gshadow are configured
      cis_ubuntu2004_rule_6_1_8: true # Ensure permissions on /etc/gshadow- are configured
      cis_ubuntu2004_rule_6_1_9: true # Ensure permissions on /etc/shells are configured
      cis_ubuntu2004_rule_6_1_10: true # Ensure permissions on /etc/opasswd are configured
      cis_ubuntu2004_rule_6_1_11: true # Ensure world writable files and directories are secured
      cis_ubuntu2004_rule_6_1_12: true # Ensure no unowned files or directories exist
      cis_ubuntu2004_rule_6_1_13: false # Ensure SUID and SGID files are reviewed -- MANUAL

      cis_ubuntu2004_rule_6_2_1: true # Ensure accounts in /etc/passwd use shadowed passwords
      cis_ubuntu2004_rule_6_2_2: true # Ensure /etc/shadow password fields are not empty
      cis_ubuntu2004_rule_6_2_3: true # Ensure all groups in /etc/passwd exist in /etc/group
      cis_ubuntu2004_rule_6_2_4: true # Ensure shadow group is empty
      cis_ubuntu2004_rule_6_2_5: true # Ensure no duplicate UIDs exist
      cis_ubuntu2004_rule_6_2_6: true # Ensure no duplicate GIDs exist
      cis_ubuntu2004_rule_6_2_7: true # Ensure no duplicate user names exist
      cis_ubuntu2004_rule_6_2_8: true # Ensure no duplicate group names exist
      cis_ubuntu2004_rule_6_2_9: true # Ensure root PATH integrity
      cis_ubuntu2004_rule_6_2_10: true # Ensure root is the only UID 0 account
      cis_ubuntu2004_rule_6_2_11: true # Ensure local interactive user home directories are configured
      cis_ubuntu2004_rule_6_2_12: true # Ensure local interactive user dot files access is configured

  - name: "Include Ubuntu 22.04 CIS role"
    when:
    - pl_a_cis_setup is defined
    - pl_a_cis_setup | bool
    - ansible_distribution | lower == "ubuntu"
    - ansible_distribution_version in ["22.04", "22.10", "23.04", "23.10"]
    ansible.builtin.include_role:
      name: ansible-cis-ubuntu-2204
    vars:
      cis_ubuntu2204_section1: true
      cis_ubuntu2204_section2: true
      cis_ubuntu2204_section3: true
      cis_ubuntu2204_section4: true
      cis_ubuntu2204_section5: true
      cis_ubuntu2204_section6: true
      cis_ubuntu2204_section7: true
      # -------------------------
      cis_ubuntu2204_rule_1_1_1_6: false # squashfs - IMPACT: Snap packages utilizes squashfs as a compressed filesystem, disabling squashfs will cause Snap packages to fail.
      # -------------------------
      cis_ubuntu2204_rule_5_1_24: true
      cis_ubuntu2204_rule_5_1_24_ssh_user: "{{ ansible_user }}"
      cis_ubuntu2204_rule_5_1_24_ssh_pub_key: "{{ pl_a_cis_setup_ssh_pub_key | default(null) }}"
      # -------------------------
      cis_ubuntu2204_rule_1_3_1_3: false # AppArmor complain mode
      cis_ubuntu2204_rule_1_3_1_4: false # AppArmor enforce mode
      # -------------------------
      cis_ubuntu2204_rule_1_4_1: false # bootloader password (disabled)
      cis_ubuntu2204_set_boot_pass: false # bootloader password (disabled)
      cis_ubuntu2204_disable_boot_pass: true # bootloader password (disabled)
      # -------------------------
      cis_ubuntu2204_rule_3_1_3: "{{ pl_a_var_server_client }}" # bluetooth service
      cis_ubuntu2204_rule_3_1_3_remove: "{{ pl_a_var_server_client }}" # bluetooth service
      # -------------------------
      cis_ubuntu2204_allow_gdm_gui: "{{ pl_a_var_client_server }}"
      cis_ubuntu2204_allow_autofs: "{{ pl_a_var_client_server }}" # Disable auto mount, set to true to allow it and not disable
      cis_ubuntu2204_rule_1_1_1_8: "{{ pl_a_var_server_client }}" # Disable USB Storage, set to false to not disable
      cis_ubuntu2204_time_synchronization_service: chrony # chrony | systemd-timesyncd
      cis_ubuntu2204_time_synchronization_time_server:
      - uri: '{{ pl_a_host_default_ntp | default("time.cloudflare.com") }}'
      - uri: '{{ pl_a_host_fallback_ntp | default("ntp.ubuntu.com") }}'
      cis_ubuntu2204_allow_cups: "{{ pl_a_var_client_server }}"
      # -------------------------
      cis_ubuntu2204_install_aide: "{{ pl_a_cis_setup_aide | default(false) | bool }}"
      cis_ubuntu2204_config_aide: "{{ pl_a_cis_setup_aide | default(false) | bool }}"
      cis_ubuntu2204_aide_cron:
        cron_user: root
        cron_file: aide
        aide_job: "/usr/bin/aide.wrapper --config /etc/aide/aide.conf --check"
        aide_minute: 0
        aide_hour: 5
        aide_day: "*"
        aide_month: "*"
        aide_weekday: "*"
      # -------------------------
      cis_ubuntu2204_journald_system_max_use: 4G
      cis_ubuntu2204_journald_system_keep_free: 8G
      cis_ubuntu2204_journald_runtime_max_use: 256M
      cis_ubuntu2204_journald_runtime_keep_free: 512M
      cis_ubuntu2204_journald_max_file_sec: 1month
      # -------------------------
      cis_ubuntu2204_required_ipv6: "{{ pl_a_cis_ipv6_required | default(false) | bool }}"
      cis_ubuntu2204_firewall: ufw
      # -------------------------
      cis_ubuntu2204_cron_allow_users:
      - root
      cis_ubuntu2204_at_allow_users:
      - root
      # -------------------------
      cis_ubuntu2204_faillock_deny: 5
      cis_ubuntu2204_faillock_unlock_time: 900
      cis_ubuntu2204_faillock_minlen: 8
      cis_ubuntu2204_password_complexity:
      - key: "minclass"
        value: "3"
      - key: "dcredit"
        value: "-1"
      - key: "ucredit"
        value: "-1"
      - key: "ocredit"
        value: "-1"
      - key: "lcredit"
        value: "-1"

  - name: "Include Ubuntu 24.04 CIS role"
    when:
    - pl_a_cis_setup is defined
    - pl_a_cis_setup | bool
    - ansible_distribution | lower == "ubuntu"
    - ansible_distribution_version in ["24.04", "24.10"]
    ansible.builtin.include_role:
      name: ansible-cis-ubuntu-2404
    vars:
      cis_ubuntu2404_section1: true
      cis_ubuntu2404_section2: true
      cis_ubuntu2404_section3: true
      cis_ubuntu2404_section4: true
      cis_ubuntu2404_section5: true
      cis_ubuntu2404_section6: true
      cis_ubuntu2404_section7: true
      # -------------------------
      cis_ubuntu2404_rule_1_1_1_4: "{{ pl_a_var_server_client }}" # hfsplus
      cis_ubuntu2404_rule_1_1_1_7: "{{ pl_a_var_server_client }}" # squashfs - IMPACT: Snap packages utilizes squashfs as a compressed filesystem, disabling squashfs will cause Snap packages to fail.
      # -------------------------
      cis_ubuntu2404_rule_5_1_24: true
      cis_ubuntu2404_rule_5_1_24_ssh_user: "{{ ansible_user }}"
      cis_ubuntu2404_rule_5_1_24_ssh_pub_key: "{{ pl_a_cis_setup_ssh_pub_key | default(null) }}"
      # -------------------------
      cis_ubuntu2404_rule_1_3_1_3: false # AppArmor complain mode
      cis_ubuntu2404_rule_1_3_1_4: false # AppArmor enforce mode
      # cis_ubuntu2404_apparmor_update_to_complain_profiles:
      #   - firefox
      # cis_ubuntu2404_apparmor_update_to_enforce_profiles:
      #   - firefox
      # -------------------------
      cis_ubuntu2404_set_boot_pass: false # bootloader password (disabled)
      cis_ubuntu2404_disable_boot_pass: true # bootloader password (disabled with cis_ubuntu2404_set_boot_pass)
      # -------------------------
      cis_ubuntu2404_rule_3_1_3: "{{ pl_a_var_server_client }}" # bluetooth service
      cis_ubuntu2404_rule_3_1_3_remove: "{{ pl_a_var_server_client }}" # bluetooth service
      # -------------------------
      cis_ubuntu2404_allow_gdm_gui: "{{ pl_a_var_client_server }}"
      cis_ubuntu2404_allow_autofs: "{{ pl_a_var_client_server }}" # Disable auto mount, set to true to allow it and not disable
      cis_ubuntu2404_rule_1_1_1_9: "{{ pl_a_var_server_client }}" # Disable USB Storage, set to false to not disable
      cis_ubuntu2404_time_synchronization_service: chrony # chrony | systemd-timesyncd
      cis_ubuntu2404_time_synchronization_time_server:
      - uri: '{{ pl_a_host_default_ntp | default("time.cloudflare.com") }}'
      - uri: '{{ pl_a_host_fallback_ntp | default("ntp.ubuntu.com") }}'
      cis_ubuntu2404_allow_cups: "{{ pl_a_var_client_server }}"
      # -------------------------
      cis_ubuntu2404_install_aide: "{{ pl_a_cis_setup_aide | default(false) | bool }}"
      cis_ubuntu2404_config_aide: "{{ pl_a_cis_setup_aide | default(false) | bool }}"
      # -------------------------
      cis_ubuntu2404_journald_system_max_use: 4G
      cis_ubuntu2404_journald_system_keep_free: 8G
      cis_ubuntu2404_journald_runtime_max_use: 256M
      cis_ubuntu2404_journald_runtime_keep_free: 512M
      cis_ubuntu2404_journald_max_file_sec: 1month
      # -------------------------
      cis_ubuntu2404_preferred_capturing_log_method: "{{ pl_a_cis_preferred_capturing_log_method | default('rsyslog') }}"
      # -------------------------
      cis_ubuntu2404_required_ipv6: "{{ pl_a_cis_ipv6_required | default(false) | bool }}"
      cis_ubuntu2404_firewall: ufw
      # -------------------------
      cis_ubuntu2404_cron_allow_users:
      - root
      cis_ubuntu2404_at_allow_users:
      - root
      # -------------------------
      cis_ubuntu2404_faillock_deny: 5
      cis_ubuntu2404_faillock_unlock_time: 900
      cis_ubuntu2404_faillock_minlen: 8
      cis_ubuntu2404_password_complexity:
      - key: "minclass"
        value: "3"
      - key: "dcredit"
        value: "-1"
      - key: "ucredit"
        value: "-1"
      - key: "ocredit"
        value: "-1"
      - key: "lcredit"
        value: "-1"

# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------
- name: "CIS | additional configs for client/server"
## remote_user: "{{ ansible_user }}"
  hosts: all
  become: true
  tasks:
  - name: "CIS | set/update system variables for aide"
    ansible.builtin.lineinfile:
      dest: "/etc/environment"
      state: present
      regexp: '^(#(\s)*)?{{ item.key }}\s*=.*$'
      line: "{{ item.key }}={{ item.value }}"
    with_items:
    - key: CRON_DAILY_RUN
      value: "yes"
    - key: MAILTO
      value: "{{ pl_a_mailing_mail_to | default('root') }}"
    - key: COPYNEWDB
      value: "yes"
    - key: TRUNCATEDETAILS
      value: "yes"
    - key: FILTERUPDATES
      value: "yes"
    - key: FILTERINSTALLATIONS
      value: "yes"
    when:
    - pl_a_cis_setup is defined
    - pl_a_cis_setup | bool
    - pl_a_cis_setup_aide is defined
    - pl_a_cis_setup_aide | bool
  - name: "CIS | set/update aide variables for aide"
    ansible.builtin.lineinfile:
      dest: "/etc/default/aide"
      state: present
      regexp: '^(#(\s)*)?{{ item.key }}\s*=.*$'
      line: "{{ item.key }}={{ item.value }}"
    with_items:
    - key: CRON_DAILY_RUN
      value: "yes"
    - key: MAILTO
      value: "{{ pl_a_mailing_mail_to | default('root') }}"
    - key: COPYNEWDB
      value: "yes"
    - key: TRUNCATEDETAILS
      value: "yes"
    - key: FILTERUPDATES
      value: "yes"
    - key: FILTERINSTALLATIONS
      value: "yes"
    when:
    - pl_a_cis_setup is defined
    - pl_a_cis_setup | bool
    - pl_a_cis_setup_aide is defined
    - pl_a_cis_setup_aide | bool
